# EDA, гипотезы и базовые модели для выявления мошенничества

## Кратко о данных

Анонимизированные транзакции (ритейл, рестораны, travel, healthcare и др.) с признаками суммы/валюты/канала/устройства/географии/типа карты и меткой `is_fraud`. Есть вложенные поведенческие признаки за последний час (`last_hour_activity`). Курсы валют — ежедневные.

## Как решали задачу

1. **Инструменты**: `pandas`, `pyarrow`, `matplotlib`, `scikit-learn`.
2. **Подготовка**:
   * Нормализация времени (UTC → naive), выделение `date`.
   * Разворачивание `last_hour_activity → lha_*`.
   * Конвертация сумм в **USD**.
3. **EDA**: распределения сумм, срезы по `channel`, `device`, времени (час/день недели/дневная серия), `vendor_category`.
4. **Валидация/метрики**: PR AUC, ROC AUC, **Recall\@FPR=0.5%**, **Expected Cost** при `C_FP=1`, `C_FN=20`.
5. **Модели**: Logistic Regression (One-Hot, class\_weight='balanced') и HistGradientBoosting (числовые признаки). Разбиение — time-based и только на новых пользователях.

## Ключевые наблюдения EDA

* **Суммы (USD)**: тяжёлый хвост; основной объём < \$1.5–2k.
  *Путь*: `/mnt/data/amount_hist.png`
* **Дневная доля фрода**: стабильна (\~19.8–20.2%), без сильных трендов.
  *Путь*: `/mnt/data/daily_fraud_rate.png`
* **Канал**: в нашем срезе `pos` показывает аномально высокий `fraud_rate` (≈1.0), что требует проверки источника канала.
  *Путь*: `/mnt/data/fraud_rate_by_channel.png`
* **Устройство**: «Chip Reader / NFC / Magnetic Stripe» также дают ≈1.0 — еще один индикатор возможной ошибки кодировки признаков.
* **По часам**: всплеск риска в окне \~01:00–04:00; днём ниже.
* **По дням недели**: слабая вариативность; воскресенье слегка выше.
* **Категории мерчантов**: почти одинаковый `fraud_rate` ≈0.20 по всем.
* **География**: Mexico (≈0.381), Russia (≈0.377), Brazil (≈0.371), Nigeria (≈0.351) — заметно выше среднего; ниже среднего: Australia (≈0.076), USA (≈0.075), France (≈0.069), UK (≈0.069), Japan (≈0.072), Singapore (≈0.064). Это указывает на необходимость гео-дифференциации правил и порогов.
* **Топ мерчантов** по числу мошенничеств: концентрирует фрод в ряде «массовых» торговцев и в сегменте топлива/аптек/доставки.

## Продуктовые гипотезы

1. В риск-сценариях (ночь 01–04, кросс-бордер, web/mobile) включаем динамический step-up/3DS (**дополнительные проверки по риску**), держим FPR ≤ 0,5%.
2. **Политика лимитов по признаку присутствия карты и устройству**: для `card-not-present` и «подозрительных» девайсов — более низкий порог суммы и ужесточённые проверки.
3. **Velocity-триггеры**: всплески `lha_num_transactions / lha_total_amount` → реал-тайм блок/ревью.
4. **Граф-сигналы**: повторное устройство/IP у разных клиентов/карт → риск-скоринг узлов и связей.
5. **Мерчант-политики**: таргетные правила по `vendor_category` и конкретным `vendor` из топ-риска (даже при «равном» среднем уровне категории).
6. **Контекстная переавторизация**: при несовпадении гео/IP/часовых поясов и истории — биометрия/OTP.
7. **DQ-контроль каналов/устройств**: из-за аномалий в EDA — отбракованные/ошибочные значения чистятся до принятия решений (предотвратить ложные блокировки).
8. **Geo-risk**: в «красных» странах (Mexico, Russia, Brazil, Nigeria) — ужесточать проверки, снижать лимиты, применять дополнительные сигналы (гео-IP, device).

## Технические гипотезы

1. **Поведенческий фичеринг** (окна 1h/6h/24h/7d) + агрегаты по `(customer|card|device|ip|vendor)` могут поднять PR AUC и Recall\@FPR.
2. **Калибровка вероятностей** (Isotonic/Platt) стабилизирует пороги под бизнес-FPR.
3. **Cost-sensitive обучение** (weights/focal) снижает **Expected Cost** при фиксированном FPR.
4. **Time-based CV + группировка по клиенту/устройству** даёт честную OOS-оценку, предотвращая утечки.

## Базовые модели и результаты

Базовой моделью стала **HistGradientBoosting (числовые признаки)**; метрики на валидации:

* **ROC AUC** = **0.978**
* **PR AUC** = **0.943**
* **Порог при FPR = 0.5%** → **Recall = 0.742**
* **Confusion (FPR≈0.005)**: TP=203 750, FP=5 502, FN=70 886, TN=1 094 989
* **Expected Cost** (`C_FP=1`, `C_FN=20`) = **1 423 222**

**Интерпретация для бизнеса**

* При FPR≈0.5% модель ловит \~**74%** мошенничества. Стоимость ошибок настроена консервативно (`FN` в 20 раз дороже `FP`).
* После **калибровки** и добавления **поведенческих/графовых** фич ожидаем рост Recall при прежнем FPR и дополнительное снижение Expected Cost.

## Как принимали решения

* **PR AUC** как основная модельная метрика из-за сильного дисбаланса.
* **Recall\@FPR=0.5%** — целевая бизнес-точка (ограничение по ложным срабатываниям).
* **Expected Cost** — ключ к порогам: выбираем порог, минимизирующий ожидаемые потери при заданных ценах FP/FN.

## Что дальше можно предпринимать

1. **Feature Engineering**: окна 1h/6h/24h/7d, частоты/суммы, уникальные мерчанты/страны, “device/IP reuse”, граф.
3. **Калибровка** вероятностей и **подбор порога** под новую матрицу затрат.
4. **А/В-валидация правил step-up** в ночные окна/кросс-бордер/дистанционные каналы.
5. **Мониторинг дрейфа** и переобучение.
6. **Интерпретация** (SHAP) для продуктовых команд: какие сигналы дают вклад в решения.

## Артефакты

* Плоты:
  `/eda_outputs/plots/amount_hist.png`
  `/eda_outputs/plots/daily_fraud_rate.png`
  `/eda_outputs/plots/fraud_rate_by_channel.png`
  `/eda_outputs/plots/fraud_rate_by_device.png`
  `/eda_outputs/plots/fraud_rate_by_dow.png`
  `/eda_outputs/plots/fraud_rate_by_hour.png`
  `/eda_outputs/plots/fraud_rate_by_vendor_category.png`
  `/eda_outputs/plots/roc_HistGradientBoosting(num-only).png`
  `/eda_outputs/plots/pr_HistGradientBoosting(num-only).png`
